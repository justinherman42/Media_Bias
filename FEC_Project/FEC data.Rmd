---
title: "Untitled"
author: "Justin Herman"
date: "7/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE)
```





```{r,echo=FALSE,warning=F,message=F}
library(tidyverse)
library(dplyr)
library(readxl)
library(knitr)
library(kableExtra)
library(xtable)
library(lubridate)
library(gganimate)
```


```{r,echo=F}
## Functions for report 
#Function take col and creates filtered cross tab of counts greater than 1
# Idea here is to identify donors who donate to multiple candidates
cross_tab_counts <- function(df,col){
#    col <- get(col)
#    print(col)
    table1 <- sort(table(col))
    my_names <- names(table1[table1>1])
    new_df <- df %>% 
    filter(col %in% my_names)
    return(new_df)
}

## Function changes occupation based upon a regular expression. 
## Creates column to note if change was made,stores old names, returns DF
cluster_jobs <- function(df,reg_express,replacement_val){    
   
    ## Populate new col with imputed value
    df$clustered_jobs[str_detect(df$clustered_jobs,reg_express)] <- replacement_val
    ## Build column to track if change was made to occupation 
    df <- df %>% 
            mutate(job_changed = ifelse(clustered_jobs == job_position,'0','1'))
    return(df)
}
```

```{r,echo=FALSE,warning=F,message=F}

## create list to import candidate level filenames
list_csv <-c( paste(as.character(2:25),".csv", sep=""))
old_df <-  as.data.frame(read.csv('csv_files/1.csv'), stringsAsFactors = FALSE)

## filter for only individual level donors
old_df <- old_df %>% 
  filter(X_ind=="IND")

## Loop to join all FEC individual csv FEC files together 
for (x in list_csv){
  new_df <- as.data.frame(read.csv(paste('csv_files/',x,sep='')), stringsAsFactors = FALSE)
  new_df <- new_df %>% 
    filter(X_ind=="IND")
  old_df <- rbind(old_df,new_df)
}

## select columns we want, create date column, filter out salaries and other "donations"
final_df <- old_df %>% 
  filter(donation_to_date_total>0) %>% 
  mutate(Date=as.Date(paste(substring(Date,1,4),substring(Date,5,6),substring(Date,7,8),sep="-")),
         Contributor_name = paste(Name2,Name1,sep=" ")
         ) %>% 
  select(comm_id,Contributor_name,address,city,state,zipcode,Date,donation_amt,donation_to_date_total,unkown2,employer,job_position) 

final_df[1:10,]
sum(final_df$donation_amt)

final_df %>% 
  filter(comm_id=="Bernie")
```

# Looking into FEC Individual level fundraising for Democratic Party

The FEC requires candidates file their contributions for the 2020 elections with the agency.  The data is uploaded as forms, which the FEC then cleans and adds to csv files.  The data seems like a treasure trove of information for anyone interested in politics.  Polls get tons of attention from week to week, but the news generally lacks any deep analysis of the FEC filings.  The most reporting the American public ever gets, is big headline numbers advertising total number of donations and total amount donated.  But the data is rich with self-identifying donor traits.  People identify the industry they work in, their position in that industry, and where they are located. We know money acts as a proxy for electoral success and we know in the 2020 primary almost all candidates have sworn off contributions from lobbyists.  On the surface, this is a noble attempt by the democratic candidates to prove they aren't influenced by big corporations.  However, digging below the surface, corporate influence clearly finds its way through other means than just lobbyists.  My idea is to look through the FEC data to find which candidates are receiving money from corporate level executives. Which candidates are receving money from corporate executives, when are they recieving it and where are they recieving it can all be answered.  We can also see if corporate executives are more liekly to attempt to capture multiple candidates with donations and which candidates are receiving money from the same executives. I mean it when I say this a is a treasuretrove of unexplored data.I will explain my process for analysis shortly, but first let me address some boring data integrity issues.  Feel free to skip the next section, it's there to outline my assumptions in data collection for anyone who distrusts my analysis. 

# Data integrity concerns

The FEC mandates quarterly reports to track the individual contributions into democratic candidate’s accounts. As a disclaimer It seems the engineers on the FEC website are slowly going through the individual files on the candidates and adding them to the Big table located on FEC pages [here](https://www.fec.gov/data/receipts/individual-contributions/?two_year_transaction_period=2020&min_date=01%2F01%2F2019&max_date=12%2F31%2F2019). Originally, I pulled the data from the above link, but the raw data is available on the website in full and some of the candidates q2 FEC filings hadn't been added to the above database.  Therefore, for this report I just grabbed all the individual level csv files and did my own manipulation on the data.  It seems I keep several individual level contributors’ (less than .1%) for each candidate that were discarded for whatever reason by the FEC data engineers. The FEC filings aren't representative of the whole population of donors, as reporting under 200 \$ isn't mandatory. We know that all these candidates have reached 100k contributors, yet most candidates in the database have less than 100k donations listed.  Some other peripheral information, caps are given on individual level contributions at 2800 per year.  Throughout the report there are some people who exceed these limits, they are known as conduits.  Conduits are individuals that act on behalf of other people to give a donation to a candidate.  These conduits aren't restricted by the \$ 2800  level if they exercise no discretion over where the funds go. With that cleared up let’s get started

Below I make several categorizing assumptions in my data manipulation operations.  The regex approach I took to clustering these groups will absolutely include some examples that do not actually represent the categorization of job title that I have made.  RegEX is a brute force attempt to categorize the occupations algorithmically. However, as I have tracked the original job occupation, you can see overwhelmingly that these job titles are correctly identified.  I display tables for each new clustered position, so that the reader understands that the approach is largely effective. My aggregated DF, is at my [website](git), I have categorized all job titles that have been changed with a binomial field to track them.  Please feel free to look at the assumptions I made and the false captures in the clusters. if you would like to take this on in your own analysis, or perhaps develop your own clusters, please feel free to do so as well.  The original unedited  job titles  are still rpesent in the dataset.  

# What's the plan?

I am going to use some regular expressions to cluster and capture job titles from the FEC data.We want to explore corporate influence, but there are so amny different combinations of the same job title, that attmepting to develop visualizations on the data is useless. My solution is to create new clustered occupation columns, which tracks and categorize occupations based upon corporate structures of power.  I.E looking at the FEC data you would find examples of the words "C.E.O" "Chief executive officer" "chief officer" "Chief executive".  I bundle all these roles into a singular role of CEO.  Other Self-reporting words like "Founder”, “EXECUTIVE DIRECTOR", and "President" are also representative of those in charge of their organization, so they are also labeled as C.E.O.  From there I step down the corporate ladder and attempt to identify all general C level executives as c level executives and place the rest of executive postions into a category of eXECS.  This was all done in careful order so as to preserrve the hierarchy of attempting to capture postions correctly.  For instance, Executive secretary's were captured first as secretary, so as to not show up as executive level job positions.  Overall I made several other clusters and the goal is to fully analyze and compare the field across all these clusters, but for this report we will focus on Corporate power structure.    

# Let's Walkthrough our CEO Clustering

The term CEO shows up 2902 times in the current FEC reports, however, the term CEO shows up over 3500 times throughout the dataset.  Below I print the top 3200 uses of the term.  You can tell The Regex did a great job in capturing terms that belong categorized as CEO.  We would display all the captures usages, but for the sake of screen time I think realizing that well over 95% of captures are clearly identified suffices

<br /> <br />


```{r,echo=F}
multiple_donations <- cross_tab_counts(final_df,final_df$Contributor_name)
## what types of fields are donating
occupation_tab <- sort(table(final_df$job_position),decreasing = TRUE)

#names(table(all_cand_df$contributor_occupation))
occupations <- names(table(final_df$job_position))
list_names <- c(occupations[str_detect(occupations,"CEO")])
all_ceo <- final_df %>% 
    filter(final_df$job_position%in% list_names )
new_tab <- sort(table(all_ceo$job_position),decreasing = TRUE)
#sum(new_tab)
#length(new_tab)
new_tab_df <- as.data.frame(new_tab[1:20])
colnames(new_tab_df) <- c('different_names','counts')
kable(new_tab_df)
```


```{r,echo=F}
 ## Build new_jobs_col
final_df <- final_df %>% 
  mutate(job_position= toupper(job_position))  %>% 
  mutate(clustered_jobs = job_position) 

## create Date column

## Job Clustering
clustered_df <- cluster_jobs(final_df,"CEO","CEO")
clustered_df$clustered_jobs <- as.character(clustered_df$clustered_jobs)
clustered_df$clustered_jobs[is.na(clustered_df$clustered_jobs)] <- "Not selected"

## Executive level positions
## WORDS INTENTIONALLY ARE REPLACED WITH SOME LOWERCASE LETTERS

clustered_df <- cluster_jobs(clustered_df,"CHIEF EXECUTIVE OFFICER","CEO")
clustered_df <- cluster_jobs(clustered_df,'CHIEF \\w* OFFICER',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'^C[A-D|F-Z]O\\b',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'/C[A-D|F-Z]O\\b',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,"MANAGING PARTNER","CEO")
clustered_df <- cluster_jobs(clustered_df,'EVP',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE VP',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'^EXECUTIVE$',"eXECS")
clustered_df <- cluster_jobs(clustered_df,'^EXECUTIVE OFFICER',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE VICE PRESIDENT',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'MANAGING DIRECTOR',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'SVP',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'^PRESIDENT\\b',"CEO")
clustered_df <- cluster_jobs(clustered_df,'^FOUNDER\\b','CEO')
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE DIRECTOR','CEO')
clustered_df <- cluster_jobs(clustered_df,'FINANCIAL DIRECTOR','C LEVEL_eXECS')
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE RECRUITER','rECRUITER')
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE SEARCH','rECRUITER')
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE ASSISTANT','EX aSSISTANT')
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE ADMINISTRATOR','EX aSSISTANT')
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE COORDINATOR','EX aSSISTANT')
clustered_df <- cluster_jobs(clustered_df,'CORPORATE EXECUTIVE','C LEVEL_eXECS')
clustered_df <- cluster_jobs(clustered_df,'EXECUTIVE$','eXECS')
clustered_df <- cluster_jobs(clustered_df,'^VP','Vp roles')
clustered_df <- cluster_jobs(clustered_df,'SVP',"C LEVEL_eXECS")
clustered_df <- cluster_jobs(clustered_df,'EXEC.*DIR','CEO')
clustered_df <- cluster_jobs(clustered_df,'VP\\b','Vp roles')
clustered_df <- cluster_jobs(clustered_df,'VICE PRESIDENT','Vp roles')
clustered_df <- cluster_jobs(clustered_df,'^DIRECTOR','eXECS')
clustered_df <- cluster_jobs(clustered_df,'^PARTNER','eXECS')

## LEGAL
clustered_df <- cluster_jobs(clustered_df,'LAWYER|ATTORNEY','ATTORNEY')

## Academia
clustered_df <- cluster_jobs(clustered_df,'PROFESSOR|TEACHER|SCHOLAR|LECTURER|DOCTORAL|INSTRUCTOR','ACADEMIA')
clustered_df <- cluster_jobs(clustered_df,'EDUC','ACADEMIA')
clustered_df <- cluster_jobs(clustered_df,'STUDENT','STUDENT')
clustered_df <- cluster_jobs(clustered_df,'LIBRAR','LIBRARIAN')
## Unemployed self employed
clustered_df <- cluster_jobs(clustered_df,'^SELF','SELF EMPLOYED')
clustered_df <- cluster_jobs(clustered_df,'^NOT-EMPLOYED$','NOT EMPLOYED')
## IT JOBS
clustered_df <- cluster_jobs(clustered_df,'^SOFTWARE','It FIELD')
clustered_df <- cluster_jobs(clustered_df,'PROGRAMMER','It FIELD')
clustered_df <- cluster_jobs(clustered_df,'^IT','It FIELD')
clustered_df <- cluster_jobs(clustered_df,'^WEB','It FIELD')
## CREATIVE 
clustered_df <- cluster_jobs(clustered_df,'DESIGNER|ARTIST|MUSICIAN|FILM|CREATIVE|PHOTO|EDITOR|WRITER','CREATIVE')
clustered_df <- cluster_jobs(clustered_df,'^(AUTHOR|ACTOR|ACTRESS)','CREATIVE')
## FINANCIAL JOBS
clustered_df <- cluster_jobs(clustered_df,'^(FINANCIAL|INVESTOR|INVESTMENT|CAPITAL|ENTREPRENEUR|FINANCE)','FINANCIAL SECTOR')
## MILITARY AND LAW ENFORCEMENT
clustered_df <- cluster_jobs(clustered_df,'MILITARY|ARMY|LAW ENFORCEMENT|FIRE','LAW ENFORCEMENT')
## Labor 
clustered_df <- cluster_jobs(clustered_df,'^(PIPE|STEAM|ELECTR|UNION)','LABORER')
clustered_df <- cluster_jobs(clustered_df,'^(TRUCK|DRIVER)','DRIVER')
clustered_df <- cluster_jobs(clustered_df,'CONTRACTOR','CONTRACTOR')
## SCIENCE AND MEDICINE
clustered_df <- cluster_jobs(clustered_df,'PHYSICIAN|MD|DOCTOR','PHYSICIAN')
clustered_df <- cluster_jobs(clustered_df,'SCIENTIST|PHYSICIST|CHEMIST','SCIENTIST')
clustered_df <- cluster_jobs(clustered_df,'PSY|SOCIAL WORKER|SOCIAL WORK','MENTAL HEALTH')
clustered_df <- cluster_jobs(clustered_df,'^RN$','RN/Nurse')
clustered_df <- cluster_jobs(clustered_df,'NURSE','RN/Nurse')
## SKILLED LABOR
clustered_df <- cluster_jobs(clustered_df,'ANALYST|ENGINEER|ARCHITECT','ANALYST/ENGINEER/ARCHITECT')
clustered_df <- cluster_jobs(clustered_df,'CPA|ACCOUNTANT|ACCOUNTING|BOOKKEEPER','ACCOUNTANT')
## Real estate
clustered_df <- cluster_jobs(clustered_df,'REALTOR|REAL ESTATE','REAL ESTATE')

## Secretary
clustered_df <- cluster_jobs(clustered_df,'SECRETARY','SECRETARY')
clustered_df <- cluster_jobs(clustered_df,'\\w ASSISTANT','SECRETARY')
```



Above I printed out the top 20 uses of the term CEO, there are 128 combinations of the term CEO that show up and we now have gone from identifying 2902 CEO's to 3533, about a 20% increase.  The cool thing is, we can expand from here. Now  I add in similar terms like mentioned in introductory paragraph. In the end we now have 4459 repsondents that represent the actual role of CEO.  I expanded this clustering to create some other fields as well.  I bundled legal,heatlh, academic,blue collar jobs into their own aggregated categories. But for the purpose of this article, we will attempt to simply look at the CEO, execs, and c lvel execs.  To get an idea of what the rolls look like in each of these categories, lets print tables of each category, by original job title.

## CEO

we have increased our CEO captures from 2902 to 7387 and you can tell the regex has been highly effective. Below I print the top 25 captured terms which make up 6858 of our total captures.  You would be hard pressed to argue any of these captures don't belong labeled as CEO.
```{r,echo=F}
all_ceo <- clustered_df %>% 
    filter(clustered_df$clustered_jobs=="CEO")
new_tab <- sort(table(all_ceo$job_position),decreasing = TRUE)
#sum(new_tab)
new_tab_df <- as.data.frame(new_tab[1:25])
#sum(new_tab_df$Freq)
colnames(new_tab_df) <- c("Different_CEO_Titles","Count")
kable(new_tab_df,caption = 'Top 6858 recategorized as CEO with original unedited job title.')
```

Now that I am done clustering CEO we can take a step down the ladder to executive level jobs followed by c level executives

## Executives

We have increased our EXECUTIVE captures from 1516 to over 7748. 

```{r,echo=F}
all_execs <- clustered_df %>% 
    filter(clustered_df$clustered_jobs=="eXECS")
new_tab <- sort(table(all_execs$job_position),decreasing = TRUE)
#sum(new_tab)
new_tab_df <- as.data.frame(new_tab[1:15])
colnames(new_tab_df) <- c("Different_ExECUTIVE_Titles","Count")
#sum(new_tab_df$Count)
kable(new_tab_df,caption = 'Top 5608 recategorized as executive  with original unedited job title.')
```

## C-Level_Execs

The last high level clustering I performed was C-level executives.  Arguably some of these positions could have been identified in the CEO cluster(Managing Director), but I decided to keep them seperate. 

```{r,echo=F}
all_C_LEVEL<- clustered_df %>% 
    filter(clustered_df$clustered_jobs=="C LEVEL_eXECS")
new_tab <- sort(table(all_C_LEVEL$job_position),decreasing = TRUE)
new_tab_df <- as.data.frame(new_tab[1:25])
colnames(new_tab_df) <- c("Different_C_level_Titles","Count")
kable(new_tab_df,caption = 'Top 997 uses of C-level executive title with original unedited job title.')
```

## Summary of Data Manipulation
 

```{r}
## Extra clustering 
# clustered_df$clustered_jobs[str_detect(clustered_df$clustered_jobs,'^FOUNDER\\b')]
# clustered_df$clustered_jobs[str_detect(clustered_df$clustered_jobs,'INSTRUCTOR')] 
# clustered_df$clustered_jobs[str_detect(clustered_df$clustered_jobs,'^IT')]
# # PROGRAMMER, 
# #sort(table(clustered_df$clustered_jobs[str_detect(clustered_df$clustered_jobs,'(LEGAL)')]),decreasing=TRUE )
# #sort(table(clustered_df$clustered_jobs[str_detect(clustered_df$clustered_jobs,'^(PIPE|STEAM|ELECTR|UNION)')]),decreasing=TRUE )
# #sort(table(clustered_df$clustered_jobs[str_detect(clustered_df$clustered_jobs,'^(FINANCIAL|INVESTOR|INVESTMENT|CAPITAL|ENTREPRENEUR)')]),decreasing=TRUE )
# clustered_df$clustered_jobs[str_detect(clustered_df$clustered_jobs,'EDITOR' )
```





```{r}
animated_donation_by_job <- function(job_positions,graph_title,filename,filter_candidates=NULL)
{  
  all_corporate_influence <- clustered_df %>% 
    filter(clustered_df$clustered_jobs%in%c(job_positions))
  if (!is.null(filter_candidates)){
    all_corporate_influence <- all_corporate_influence %>% 
      filter(comm_id %in% filter_candidates)
  }   
allnames <- data.frame(rep(unique(all_ceo$comm_id),27))
build_dates <- rep(seq(as.Date("2018-12-31	"), as.Date("2019-07-01	"), by = "week"),13)
build_dates <- sort(as.Date(build_dates))
cart_df <- as.data.frame(cbind(allnames,build_dates))
colnames(cart_df) <- c("comm_id","Date")

## build our df
#all_ceo$Date <-as.Date(all_ceo$contribution_receipt_date) 
all_corporate_influence$comm_id <- as.factor(all_corporate_influence$comm_id)
all_corporate_influence <- all_corporate_influence %>% 
  filter(Date> as.Date("2018-12-31"))

##cartesian join 
all_corporate_influence$Date <-as.Date(cut(all_corporate_influence$Date,"week")) 
aa <- plyr::join(all_corporate_influence,cart_df,type="left", by=c("comm_id","Date"))
weekly_donations <- aa %>% group_by(comm_id,Date) %>% 
                          summarise(value = sum(donation_amt)/1000000) %>% 
                          complete(comm_id,Date)
weekly_donations[is.na(weekly_donations)] <- 0
weekly_donations <- weekly_donations [!duplicated(weekly_donations),]
weekly_donations <- weekly_donations %>% 
  arrange(Date)

## build cumsum,quarter,weeklyrank columns
weekly_donations$Money_Raised <- ave(weekly_donations$value, weekly_donations$comm_id, FUN=cumsum)
weekly_donations$quarter <- ifelse(as.Date(weekly_donations$Date)< as.Date('2019-04-01'),1,2)
weekly_donations <- weekly_donations %>%
  group_by(Date) %>%
  mutate(ordering = min_rank(-Money_Raised * 1.0)) %>%
  ungroup() 

# animated  barplot:
my_animation <- weekly_donations %>% 
  ggplot( aes(x=ordering,group = comm_id,fill=comm_id)) + 
#  geom_bar(stat='identity')+
geom_tile(aes(y =Money_Raised/2 , 
                height = Money_Raised,
                width = 0.9), alpha = 0.9) +
  geom_text(aes(y = Money_Raised, label = comm_id), vjust = -0.5) +
  # text in x-axis (requires clip = "off" in coord_cartesian)
  geom_text(aes(y = 0, label = comm_id), vjust = 2) +
  coord_cartesian(clip = "off", expand = FALSE) +
  labs(title=paste(graph_title, '{closest_state}'), x = "") +
  theme(plot.title = element_text(hjust = 1, size = 22),
        axis.ticks.x = element_blank(),
        axis.text.x  = element_blank()) + 
  transition_states(Date, 
                    transition_length = 2, state_length = 1) 

animate(my_animation, 200, fps = 10, duration = 10, width = 800, height = 600, renderer = gifski_renderer(paste(filename,".gif",sep=""),loop = F ))

animated_donation_by_job("CEO","my graph for CEO")
animated_donation_by_job("ACADEMIA","Cumulative donations by donors working in Acedemics","academics",c("Bernie","Warren"))

```

