---
title: "happy"
author: "Justin Herman"
date: "7/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(stringsAsFactors = FALSE)
```


## High level Plan 

**Get more Doners**. Dig through FEC report for trends in donor characteristics.  Attempt to label targets for fundraising drive by order of importance.  High level targets, should be contacted by intimate mean(Phone, invite to meet campaign, invite to fundraiser etc). Middle targets presumably should be given second priority( letter campaign), and  low level targets by cheapest means possible. 

Easiest way to identify high level targets, donors who have givenmax or near max to multiple candidates, but have not donated to booker campaign yet. Other possible high level targets are big money donors labeled with executive level positons.  Possible mid level donors to target would be anyone in the law field, Senator performs well in that occupation. For low value targets, donors donating small amounts of money to multiple candidates.      


## Semi-technical approach

Below approach is quick dirty approach to analyzing the FEC data that comes in quarterly.  We would want a more reproducible script to perform analysis so we can just run day 1 when q2 comes in. But refactoring this can be something to think about later.  First step in analysis is to clean up FEC reports, job role reporting is a mess. If we want to find trends in occupational demographics, these groups need to be aggregated in some way.   I want to manually create hierichal job clusters.  Important positions are correlated with high income and a need to exert political influence.  We miss out on tons of potential donors in these reports, because we don't capture their occupation correctly. For instance on the highest and likely most important level, anyone listing job as "Cheif Executive OFFICER" or "CEO / CIO" "CO-CEO", may get lost in the data. Let's manipulate the data and cluster similar positions into specific job types.  In the above example we want all of these job titles to just be CEO.  From here we can step down the power ladder to  chief officers and any exectuive positions. Next we need to think about jobs that are similar I.E (Private equity and Private investments ). In the end we will have a much better starting point for identifying trends. We will also be able to compare what position/industry our oppnents are doing a better job at capturing as well as understnading the overlap and therefore potential likely previous donors that we can win over     
 
 On a technical note, the regex expressions are sort of a brute force solution.  If we start from the top we may be increasing our false positive's in locating potential donors( an executive assistant may slip into executive category).  However, we can easily keep track of original title postions in a seperate table and reaching out to false positives is much better than missing out on potential strong donors. The reality is we can pretty easily capture mistakes like categorizing "Executive Assistant" as executive instead of as "Assistant", but none the less some mistakes will creep in.    
 
Once the occupations are properly "clustered", we will build some visualations to see how candidates do based upon location and occupation.  Next we find our high level targets, donors that have maxed out contributions for other candidates, specifically for donors that have maxed out contributions to multiple candidates.  Occupation aside, these should be top priority targets. Direction and clarity would help here. 

**There are certain donations which are earmarked donations, which seem to indicate a bundler doner. These doners aren't held to the maxed out 2800 contribution.  It appears they don't need to disclose in these filings, where they are getting their funds from. Although from reading, it appears they do need to keep track of it. Is this reported somehwere? Can we see if they work for cmapaign somewhere?  Clearly these bundlers should be targets, but without clarity from the team on what is going on here, I would wait to analyze these individuals.**        


##  Grab Booker, Kamala, bernie, Buttigeg, Warren
+ Im manually pulling this data and there is a 50k row limit on each report.  This would need to be fixed up to really just scrape the website to capture all rows.
    + visualization functions will work regardless.  Scraping entire report into one df, versus loading part of report makes no technical difference.   


## Ideas for getting more from data

** Morally questionable ** 
+ NLP to determine race based upon names( seems like something like this could work https://github.com/appeler/ethnicolr)
+ match zip codes with racial demographics to determine viable targets 


```{r}
library(tidyverse)
library(readxl)
booker_only <- as.data.frame(read.csv('booker.csv'))
df2 <- as.data.frame(read.csv('Kamala_Bernie_Biden_Buttigeg_Warren.csv'))
df3 <- as.data.frame(read.csv('Castro_Gillibrand.csv'))
all_cand_df<- rbind(booker_only,df2,df3)

 ## Build new_jobs_col
all_cand_df <- all_cand_df %>% 
    mutate(clustered_jobs = contributor_occupation)

```

```{r}
## Function changes occupation based upon a regular expression. 
## Creates column to note if change was made,stores old names, returns DF
cluster_jobs <- function(df,reg_express,replacement_val){    
   
    ## Populate new col with imputed value
    df$clustered_jobs[str_detect(df$clustered_jobs,reg_express)] <- replacement_val
    ## Build column to track if change was made to occupation 
    df <- df %>% 
            mutate(job_changed = ifelse(clustered_jobs == contributor_occupation,'0','1'))
    return(df)
}


# Function used to find donors who  have donated multiple times
# Function takes df and returns new df filtered for multiple donors only 
cross_tab_counts <- function(df,col){
    
    table1 <- sort(table(col))
    ## build list donors counts > 1
    my_names <- names(table1[table1>1])
    ## fitler df for donors with >1 
    new_df <- df %>% 
        filter(col %in% my_names)
    return(new_df)
}


multiple_donations <- cross_tab_counts(all_cand_df,all_cand_df$contributor_name)



rsconnect::setAccountInfo(name='justinherman',
			  token='2D50CD7AB193830EBBD7219E5B7DC19D',
			  secret='H3alkGs4qxGWMwmSYBZQ/lAsExu831OQfpza63zw')
rsconnect::deployApp()
```


+ In terms of occupations what sticks out right away is there need to be a way to cluster the "important" positions
+ As these filings are standard, I think this can be done manually, but needs to be done with hierarcy in mind 

```{r}

## start with 296 positions 
#length(table(df$contributor_occupation))

summary(df$contribution_receipt_amount)


## what types of fields are donating
occupation_tab <- sort(table(df$contributor_occupation))
names(table(df$contributor_occupation))

## Transform occupations hierarchy matters


occupations <- names(table(df$contributor_occupation))
occupations[str_detect(occupations,"CEO")]


occupations[str_detect(occupations,'VICE ')]
occupations[str_detect(occupations,'ASSISTANT|ASST')]
occupations[str_detect(occupations,'ASST')]
occupations[str_detect(occupations,'EXECUTIVE ')]
occupations[str_detect(occupations,'VICE PRESIDENT| VP')]
occupations[str_detect(occupations,'PRESIDENT')]
occupations[str_detect(occupations,'DIRECTOR')]
occupations[str_detect(occupations,'VP')]
occupations[str_detect(occupations,' C[A-Z]O')]
occupations[str_detect(occupations,'C[A-D]|[F:Z]O')]
occupations[str_detect(occupations,'(\\w OFFICER')]
occupations[str_detect(occupations,'PRIVATE')]
occupations[str_detect(occupations,'INSURANCE')]
occupations[str_detect(occupations,'CORPORATE')]
occupations[str_detect(occupations,'CHAIR')]
occupations[str_detect(occupations,'DIRECTOR')]
occupations[str_detect(occupations,'CHARITY')]
occupations[str_detect(occupations,'FOUNDATION')]
occupations[str_detect(occupations,'FINANCE| INVEST')]
occupations[str_detect(occupations,'CONSULT')]
occupations[str_detect(occupations,'MARKET')]
occupations[str_detect(occupations,'REAL')]
occupations[str_detect(occupations,'PORTFOLIO')]
occupations[str_detect(occupations,'MANAGER')]
occupations[str_detect(occupations,'VENTURE|FINANCE|CAPITAL|EQUITY')]
occupations[str_detect(occupations,'ANALYST')]
#grepl( "CEO" , names(table(df$contributor_occupation) ) 
#apply(grepl)








df <- as.data.frame(read.csv('booker.csv'))
df$contributor_occupation<- cluster_jobs("CEO","CEO")
df$contributor_occupation<- cluster_jobs("ASSISTANT","ASSISTANT")
df$contributor_occupation<- cluster_jobs('VICE PRESIDENT| VP',"VICE PRESIDENT")

## data check example 

table(df$contribution_receipt_amount[df$contributor_occupation=="CEO"])







# 
# all_cand_df
# cluster_jobs(all_cand_df,"CEO","CEO")
# all_cand_df$contributor_occupation[str_detect(all_cand_df$contributor_occupation,'CEO')]





#df_5$job_changed[str_detect(df_5$job_changed,'CEO')]
#table(df_5$job_changed)
#df_5$clustered_jobs[str_detect(df_5$clustered_jobs,"CEO")]
#df_5$contributor_occupation[str_detect(df_5$contributor_occupation,"CEO")]
```


## Example of what we are doing 
```{r}
df_5 <- cluster_jobs(all_cand_df,"CEO","CEO")



new_jobs_col <- as.character(df_5$clustered_jobs[str_detect(df_5$clustered_jobs,"CEO")])
old_jobs <- as.character(df_5$contributor_occupation[str_detect(df_5$contributor_occupation,"CEO")])
```


** Original results 467 CEO **
```{r}

sort(table(old_jobs),decreasing=TRUE)
```




** Captures all CEO as CEO, 569 results **
```{r}

table(new_jobs_col)



#(569-467)/467
```


** 22% increase in capturing CEO's for targeting**
Looking at the results above, there is one false positive( VOI'CEO'VER Actor) was captured. For high level targets, this is why we keep track of all changes and we can adjust accordingly. Continuing the quest to find all these high level targets, below we cluster the over 135 different combinations of any 3 letter c level exec(besides CEO) as well as over 50 occurences of "Chief [positon] officer" and impute these results as c level execs.  We will add in all EVP roles as well here  

 Now we can add in synonyms like "PRESIDENT" and "FOUNDER" .  These assumptions can definitely be finer tuned. Talking with HR would be extremely helpful in clustering.  At this point, I think the reasoning behind imputations makes sense, so I'll start clustering.

```{r}

df_5 <- cluster_jobs(all_cand_df,"CEO","CEO")
df_5$clustered_jobs <- as.character(df_5$clustered_jobs)
df_5$clustered_jobs[is.na(df_5$clustered_jobs)] <- "Not selected"


## Executive level positions
## WORDS INTENTIONALLY ARE REPLACED WITH SOME LOWERCASE LETTERS

df_5 <- cluster_jobs(df_5,"CHIEF EXECUTIVE OFFICER","CEO")
df_5 <- cluster_jobs(df_5,'CHIEF \\w* OFFICER',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'^C[A-D|F-Z]O\\b',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'/C[A-D|F-Z]O\\b',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,"MANAGING PARTNER","CEO")
df_5 <- cluster_jobs(df_5,'EVP',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'EXECUTIVE VP',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'^EXECUTIVE$',"eXECS")
df_5 <- cluster_jobs(df_5,'^EXECUTIVE OFFICER',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'EXECUTIVE VICE PRESIDENT',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'MANAGING DIRECTOR',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'SVP',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'^PRESIDENT\\b',"CEO")
df_5 <- cluster_jobs(df_5,'^FOUNDER\\b','CEO')
df_5 <- cluster_jobs(df_5,'EXECUTIVE DIRECTOR','CEO')
df_5 <- cluster_jobs(df_5,'FINANCIAL DIRECTOR','C LEVEL_eXECS')
df_5 <- cluster_jobs(df_5,'EXECUTIVE RECRUITER','rECRUITER')
df_5 <- cluster_jobs(df_5,'EXECUTIVE SEARCH','rECRUITER')
df_5 <- cluster_jobs(df_5,'EXECUTIVE ASSISTANT','EX aSSISTANT')
df_5 <- cluster_jobs(df_5,'EXECUTIVE ADMINISTRATOR','EX aSSISTANT')
df_5 <- cluster_jobs(df_5,'EXECUTIVE COORDINATOR','EX aSSISTANT')
df_5 <- cluster_jobs(df_5,'CORPORATE EXECUTIVE','C LEVEL_eXECS')
df_5 <- cluster_jobs(df_5,'EXECUTIVE$','eXECS')
df_5 <- cluster_jobs(df_5,'^VP','Vp roles')
df_5 <- cluster_jobs(df_5,'SVP',"C LEVEL_eXECS")
df_5 <- cluster_jobs(df_5,'EXEC.*DIR','CEO')
df_5 <- cluster_jobs(df_5,'VP\\b','Vp roles')
df_5 <- cluster_jobs(df_5,'VICE PRESIDENT','Vp roles')
df_5 <- cluster_jobs(df_5,'^DIRECTOR','eXECS')
df_5 <- cluster_jobs(df_5,'^PARTNER','eXECS')


## LEGAL
df_5 <- cluster_jobs(df_5,'LAWYER|ATTORNEY','ATTORNEY')

## Academia
df_5 <- cluster_jobs(df_5,'PROFESSOR|TEACHER|SCHOLAR|LECTURER|DOCTORAL|INSTRUCTOR','ACADEMIA')
df_5 <- cluster_jobs(df_5,'EDUC','ACADEMIA')
df_5 <- cluster_jobs(df_5,'STUDENT','STUDENT')
df_5 <- cluster_jobs(df_5,'LIBRAR','LIBRARIAN')
## Unemployed self employed
df_5 <- cluster_jobs(df_5,'^SELF','SELF EMPLOYED')
df_5 <- cluster_jobs(df_5,'^NOT-EMPLOYED$','NOT EMPLOYED')
## IT JOBS
df_5 <- cluster_jobs(df_5,'^SOFTWARE','It FIELD')
df_5 <- cluster_jobs(df_5,'PROGRAMMER','It FIELD')
df_5 <- cluster_jobs(df_5,'^IT','It FIELD')
df_5 <- cluster_jobs(df_5,'^WEB','It FIELD')
## CREATIVE 
df_5 <- cluster_jobs(df_5,'DESIGNER|ARTIST|MUSICIAN|FILM|CREATIVE|PHOTO|EDITOR|WRITER','CREATIVE')
df_5 <- cluster_jobs(df_5,'^(AUTHOR|ACTOR|ACTRESS)','CREATIVE')
## FINANCIAL JOBS
df_5 <- cluster_jobs(df_5,'^(FINANCIAL|INVESTOR|INVESTMENT|CAPITAL|ENTREPRENEUR|FINANCE)','FINANCIAL SECTOR')
## MILITARY AND LAW ENFORCEMENT
df_5 <- cluster_jobs(df_5,'MILITARY|ARMY|LAW ENFORCEMENT|FIRE','LAW ENFORCEMENT')
## Labor 
df_5 <- cluster_jobs(df_5,'^(PIPE|STEAM|ELECTR|UNION)','LABORER')
df_5 <- cluster_jobs(df_5,'^(TRUCK|DRIVER)','DRIVER')
df_5 <- cluster_jobs(df_5,'CONTRACTOR','CONTRACTOR')
## SCIENCE AND MEDICINE
df_5 <- cluster_jobs(df_5,'PHYSICIAN|MD|DOCTOR','PHYSICIAN')
df_5 <- cluster_jobs(df_5,'SCIENTIST|PHYSICIST|CHEMIST','SCIENTIST')
df_5 <- cluster_jobs(df_5,'PSY|SOCIAL WORKER|SOCIAL WORK','MENTAL HEALTH')
df_5 <- cluster_jobs(df_5,'^RN$','RN/Nurse')
df_5 <- cluster_jobs(df_5,'NURSE','RN/Nurse')
## SKILLED LABOR
df_5 <- cluster_jobs(df_5,'ANALYST|ENGINEER|ARCHITECT','ANALYST/ENGINEER/ARCHITECT')
df_5 <- cluster_jobs(df_5,'CPA|ACCOUNTANT|ACCOUNTING|BOOKKEEPER','ACCOUNTANT')
## Real estate
df_5 <- cluster_jobs(df_5,'REALTOR|REAL ESTATE','REAL ESTATE')

## Secretary
df_5 <- cluster_jobs(df_5,'SECRETARY','SECRETARY')
df_5 <- cluster_jobs(df_5,'\\w ASSISTANT','SECRETARY')



sort(table(df_5$clustered_jobs),decreasing=TRUE)[0:50]



df_5$clustered_jobs[str_detect(df_5$clustered_jobs,'^FOUNDER\\b')]

df_5$clustered_jobs[str_detect(df_5$clustered_jobs,'INSTRUCTOR')] 
df_5$clustered_jobs[str_detect(df_5$clustered_jobs,'^IT')]
# PROGRAMMER, 

sort(table(df_5$clustered_jobs[str_detect(df_5$clustered_jobs,'(LEGAL)')]),decreasing=TRUE )
sort(table(df_5$clustered_jobs[str_detect(df_5$clustered_jobs,'^(PIPE|STEAM|ELECTR|UNION)')]),decreasing=TRUE )
sort(table(df_5$clustered_jobs[str_detect(df_5$clustered_jobs,'^(FINANCIAL|INVESTOR|INVESTMENT|CAPITAL|ENTREPRENEUR)')]),decreasing=TRUE )


df_5$clustered_jobs[str_detect(df_5$clustered_jobs,'EDITOR' )]

```

## Now that we have CEO's we can dig into the data and see how candidates perform with CEO's


```{r}
library(dplyr)
CEO_DF <- df_5 %>% 
    filter(clustered_jobs == "CEO")
      

CEO_DF$committee_name <- as.character(CEO_DF$committee_name)
CEO_DF %>% 
    group_by(committee_name) %>% 
    dplyr::summarize(donations = n(),mean_donation = mean(contribution_receipt_amount), median_donation = median(contribution_receipt_amount),total_contribution=sum(contribution_receipt_amount) ) %>% 
    arrange(desc(total_contribution),desc(median_donation))

## WIthin CEO How is Booker doing 

CEO_DF %>% 
    filter(committee_name == "CORY 2020") %>% 
    group_by(contributor_occupation) %>% 
    dplyr::summarize(donations = n(),mean_donation = mean(contribution_receipt_amount), median_donation = median(contribution_receipt_amount),total_contribution=sum(contribution_receipt_amount) ) %>% 
    arrange(desc(donations),desc(median_donation))

CEO_DF %>% 
    filter(committee_name == "BERNIE 2020") %>% 
    group_by(contributor_occupation) %>% 
    dplyr::summarize(donations = n(),mean_donation = mean(contribution_receipt_amount), median_donation = median(contribution_receipt_amount),total_contribution=sum(contribution_receipt_amount) ) %>% 
    arrange(desc(donations),desc(median_donation))




sort(table(as.character(CEO_DF$contributor_occupation)),decreasing=TRUE)



```

## No biden for q1

```{r}
library(lemon)
knit_print.data.frame <- lemon_print


cross_tab_counts <- function(df,col){
#    col <- get(col)
#    print(col)
    table1 <- sort(table(col))
    my_names <- names(table1[table1>1])
    print(my_names)
    new_df <- df %>% 
    filter(col %in% my_names)
    return(new_df)
}

#sort(table(df$contributor_occupation),decreasing=TRUE )

multiple_donations <- cross_tab_counts(df2,df2$contributor_name)
## Big Fish Targets
multiple_donations <- multiple_donations %>% 
    filter(contribution_receipt_amount>2000) %>% 
    group_by(contributor_name,committee_name) %>% 
    summarize(total_given_to_candidate = sum(contribution_receipt_amount))


target_names <- as.character(multiple_donations$contributor_name[duplicated(multiple_donations$contributor_name)])



## donors that have donated to Our Campaign and other campaigns 
our_shared_donors <- multiple_donations %>% 
    filter(contributor_name %in% target_names)

## what characteristics do they share
df_4 <- df2 %>% 
    filter(contributor_name %in% our_shared_donors$contributor_name)


## Questions to ask, what are their professions?  
sort(table(df_4$contributor_occupation),decreasing = TRUE)

## Where are they located? 
    
## Employers?    
```